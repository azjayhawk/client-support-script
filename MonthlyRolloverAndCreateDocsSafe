/************************************
 * RadiateU ‚Äî Client Support Tracker (2026)
 * Combined Script (Clean Drop-in)
 *
 * IMPORTANT (Drive API):
 * This script uses Drive.Files.update() to place newly-created docs into the client folder.
 * To avoid errors, enable BOTH:
 * 1) Apps Script ‚Üí Services ‚Üí Advanced Google services‚Ä¶ ‚Üí Drive API (ON)
 * 2) Google Cloud Console ‚Üí APIs & Services ‚Üí Library ‚Üí Google Drive API (ENABLED)
 ************************************/

/**
 * CONFIG
 */
const MASTER_SHEET_NAME = "Master Tracker 2026";
const DIRECTORY_SHEET_NAME = "Client Directory";
const TIME_ENTRY_SHEET = "Time Entry";

// Change if your Time Entry template row is different:
const TIME_ENTRY_TEMPLATE_ROW = 3;

// Parent folder that contains all client folders:
const PARENT_FOLDER_ID = "1UI4zQ_YIEWWJT0kSP2x8EaQlue303Xl-";

// Your logo file ID (Drive):
const LOGO_FILE_ID = "1fW300SGxEFVFvndaLkkWz3_O7L3BOq84";

/**
 * getOrCreateClientFolder
 * Creates or retrieves a folder for a client under the designated parent folder.
 */
function getOrCreateClientFolder(parentFolder, clientName) {
  const folders = parentFolder.getFoldersByName(clientName);
  return folders.hasNext() ? folders.next() : parentFolder.createFolder(clientName);
}

/**
 * monthlyRolloverAndCreateDocsSafe
 * Creates monthly support summary docs in the correct client folder.
 *
 * Assumes Master Tracker 2026 headers:
 * A Month
 * B Client Name
 * C Status
 * D Block Hours Starting Balance
 * E Hours Used (This Month)
 * F Block Hours Remaining (formula)
 * G Hours Purchased This Month
 * H Block Balance End of Month (formula)
 * K Client Email
 * L First Name
 * N Domain Expiration
 * O Access to GA
 * P Report Folder URL
 * Q Monthly Support Doc Link
 */
function monthlyRolloverAndCreateDocsSafe() {
  const DRY_RUN = false; // set true if testing only (won't write docs)

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  const masterSheet = ss.getSheetByName(MASTER_SHEET_NAME);
  if (!masterSheet) throw new Error(`Sheet "${MASTER_SHEET_NAME}" not found.`);

  const timeZone = ss.getSpreadsheetTimeZone();

  // Parent folder that contains all client folders
  const parentFolder = DriveApp.getFolderById(PARENT_FOLDER_ID);

  // Month label (previous month)
  const today = new Date();
  today.setMonth(today.getMonth() - 1);
  const monthLabel = Utilities.formatDate(today, timeZone, "MMMM yyyy");
  const timestamp = Utilities.formatDate(new Date(), timeZone, "yyyy-MM-dd HH:mm:ss");

  // Summary sheet
  const summarySheet = ss.getSheetByName("Document Summary") || ss.insertSheet("Document Summary");
  summarySheet.clear();
  summarySheet.appendRow(["Client Name", "Email", "Doc URL", "Timestamp"]);

  // Write Month Label in Column A (starting Row 3)
  const lastRow = masterSheet.getLastRow();
  if (lastRow > 2) {
    masterSheet.getRange(3, 1, lastRow - 2, 1).setValue(monthLabel);
  }

  // Read all rows once
  const data = masterSheet.getDataRange().getValues();

  // Skip header row (row 1) + template row (row 2)
  const rows = data.slice(2);

  let createdCount = 0;

  rows.forEach((row, i) => {
    const rowNum = i + 3; // rows[0] corresponds to sheet row 3

    const clientName     = row[1];  // B
    const status         = row[2];  // C
    const startingBlock  = row[3];  // D
    const hoursUsed      = row[4];  // E
    // F is formula; we do not need it for doc content
    const hoursPurchased = row[6];  // G
    const endBalance     = row[7];  // H
    const clientEmail    = row[10]; // K
    const firstName      = row[11]; // L
    const domainExpire   = row[13]; // N
    const accessToGA     = row[14]; // O

    const trimmedName = (typeof clientName === "string") ? clientName.trim() : "";
    if (!trimmedName) return;

    // Skip inactive / transitioning
    const st = (status || "").toString().trim().toLowerCase();
    if (st === "inactive" || st === "transitioning") return;

    const docName = `${monthLabel} - ${clientName}`;
    const clientFolder = getOrCreateClientFolder(parentFolder, clientName);

    // Check if doc already exists in the client folder
    let file;
    let doc;
    const existingFiles = clientFolder.getFilesByName(docName);

    while (existingFiles.hasNext()) {
      const candidate = existingFiles.next();
      if (candidate.isTrashed()) {
        candidate.setTrashed(false);
        console.log(`‚ôªÔ∏è Restored trashed doc for ${clientName}`);
      }
      file = candidate;
      break;
    }

    if (file) {
      doc = DocumentApp.openById(file.getId());
      console.log(`‚ôªÔ∏è Reusing existing doc for ${clientName}`);
    } else {
      // Create doc then assign it to the client folder via Drive API
      doc = DocumentApp.create(docName);

      if (DRY_RUN) {
        console.log(`üü° Dry run - would have created doc for ${clientName}`);
        return;
      }

      const createdFile = DriveApp.getFileById(doc.getId());

      // Move into client folder via Drive API (no "moveTo", avoids trashing)
      Drive.Files.update(
        { parents: [{ id: clientFolder.getId() }] },
        createdFile.getId()
      );

      console.log(`üÜï Created new doc for ${clientName} in client folder`);
    }

    if (DRY_RUN) return;

    // Write document content
    const body = doc.getBody();
    body.clear();

    // Insert logo
    const logoBlob = DriveApp.getFileById(LOGO_FILE_ID).getBlob();
    const image = body.appendImage(logoBlob);
    image.setWidth(144).setHeight(83); // 2in √ó ~1.16in

    body.appendParagraph(`Hello ${firstName || ""},`);
    body.appendParagraph("");

    body.appendParagraph(`Here‚Äôs your monthly support summary for ${clientName} ‚Äì ${monthLabel}:`);
    body.appendParagraph("");

    const fmt = v => (typeof v === "number" ? v.toFixed(2) : (v || "0"));

    body.appendParagraph(`Block Hours Starting Balance: ${fmt(startingBlock)}`);
    body.appendParagraph(`Hours Used This Month: ${fmt(hoursUsed)}`);
    body.appendParagraph(`Hours Purchased This Month: ${fmt(hoursPurchased)}`);
    body.appendParagraph(`Block Balance End of Month: ${fmt(endBalance)}`);
    body.appendParagraph("");

    body.appendParagraph("If you need additional support hours, visit https://radiateu.com/request-support-time.");
    body.appendParagraph("");

    const formattedDomainExpire = domainExpire instanceof Date
      ? Utilities.formatDate(domainExpire, timeZone, "MMM dd, yyyy")
      : (domainExpire || "N/A");

    body.appendParagraph("üîê Domain Expiration: " + formattedDomainExpire);
    body.appendParagraph("üìä Access to Google Analytics: " + (accessToGA || "N/A"));
    body.appendParagraph("");

    body.appendParagraph("If you have any questions, feel free to reply here or send a message to support@radiateu.com.");
    body.appendParagraph("");
    body.appendParagraph("Warm regards,");
    body.appendParagraph("The RadiateU Team");

    doc.saveAndClose();

    // Update Master Tracker links (P/Q)
    const docUrl = doc.getUrl();
    masterSheet.getRange(rowNum, 17).setFormula(`=HYPERLINK("${docUrl}", "Open Doc")`); // Q
    masterSheet.getRange(rowNum, 16).setFormula(`=HYPERLINK("${clientFolder.getUrl()}", "Open Folder")`); // P

    summarySheet.appendRow([clientName, clientEmail || "N/A", docUrl, timestamp]);
    createdCount++;
    console.log(`‚úÖ Created support doc for ${clientName}`);
  });

  ui.alert(`‚úÖ ${createdCount} support summaries were created.`);
}

/**
 * insertAllMissingClients
 * Inserts all clients from Client Directory into Master Tracker 2026 if missing.
 *
 * Master Tracker assumptions:
 * - Template row is Row 2
 * - Data starts at Row 3
 *
 * Writes:
 * B Client Name  <- dir A
 * C Status       <- dir D
 * K Client Email <- dir C
 * L First Name   <- dir F
 * M Last Name    <- dir G
 *
 * Clears:
 * P Report Folder URL
 * Q Monthly Support Doc Link
 */
function insertAllMissingClients() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  const directorySheet = ss.getSheetByName(DIRECTORY_SHEET_NAME);
  const masterSheet = ss.getSheetByName(MASTER_SHEET_NAME);

  if (!directorySheet) throw new Error(`Sheet "${DIRECTORY_SHEET_NAME}" not found.`);
  if (!masterSheet) throw new Error(`Sheet "${MASTER_SHEET_NAME}" not found.`);

  const dirData = directorySheet.getDataRange().getValues();

  // Existing client names in Master Tracker (Column B), starting Row 3
  const lastMasterRow = masterSheet.getLastRow();
  const existing = (lastMasterRow >= 3)
    ? masterSheet.getRange(3, 2, lastMasterRow - 2, 1).getValues()
        .map(r => (r[0] || "").toString().trim().toLowerCase())
    : [];

  const newClients = [];
  for (let i = 1; i < dirData.length; i++) { // skip directory header
    const name = dirData[i][0]; // A
    if (!name) continue;

    const lowerName = name.toString().trim().toLowerCase();
    if (!existing.includes(lowerName)) newClients.push(dirData[i]);
  }

  if (newClients.length === 0) {
    ui.alert("‚úÖ No missing clients to insert.");
    return;
  }

  const TEMPLATE_ROW = 2;

  newClients.forEach(client => {
    const lastRow = masterSheet.getLastRow();
    masterSheet.insertRowAfter(lastRow);

    // Copy template row (formatting, validation, formulas)
    const templateRange = masterSheet.getRange(TEMPLATE_ROW, 1, 1, masterSheet.getLastColumn());
    const newRowRange = masterSheet.getRange(lastRow + 1, 1, 1, masterSheet.getLastColumn());
    templateRange.copyTo(newRowRange, SpreadsheetApp.CopyPasteType.PASTE_NORMAL, false);

    // Fill values (2026 layout)
    masterSheet.getRange(lastRow + 1, 2).setValue(client[0]); // B Client Name (dir A)
    masterSheet.getRange(lastRow + 1, 3).setValue(client[3]); // C Status (dir D)
    masterSheet.getRange(lastRow + 1, 11).setValue(client[2]); // K Email (dir C)
    masterSheet.getRange(lastRow + 1, 12).setValue(client[5]); // L First Name (dir F)
    masterSheet.getRange(lastRow + 1, 13).setValue(client[6]); // M Last Name (dir G)

    // Clear links in P/Q
    masterSheet.getRange(lastRow + 1, 16).clearContent(); // P Folder URL
    masterSheet.getRange(lastRow + 1, 17).clearContent(); // Q Doc Link
  });

  ui.alert(`‚úÖ Inserted ${newClients.length} new client(s) into ${MASTER_SHEET_NAME}.`);
}

/**
 * insertNewClientIntoDirectory
 * Prompts for new client and inserts into Client Directory using row 2 as formatting template.
 *
 * Directory columns assumed:
 * A Client Name
 * B Plan Type
 * C Email
 * D Status
 * E Partner
 * F First Name
 * G Last Name
 */
function insertNewClientIntoDirectory() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(DIRECTORY_SHEET_NAME);
  if (!sheet) throw new Error(`Sheet "${DIRECTORY_SHEET_NAME}" not found.`);

  const clientNamePrompt = ui.prompt("New Client", "Enter the client domain or name:", ui.ButtonSet.OK_CANCEL);
  if (clientNamePrompt.getSelectedButton() !== ui.Button.OK) return;

  const planPrompt = ui.prompt("Plan Type", "Enter plan type:", ui.ButtonSet.OK_CANCEL);
  if (planPrompt.getSelectedButton() !== ui.Button.OK) return;

  const emailPrompt = ui.prompt("Email", "Enter client email address:", ui.ButtonSet.OK_CANCEL);
  if (emailPrompt.getSelectedButton() !== ui.Button.OK) return;

  const partnerPrompt = ui.prompt("Client Partner", "Enter Client Partner (if applicable):", ui.ButtonSet.OK_CANCEL);
  if (partnerPrompt.getSelectedButton() !== ui.Button.OK) return;

  const firstNamePrompt = ui.prompt("First Name", "Enter the first name:", ui.ButtonSet.OK_CANCEL);
  if (firstNamePrompt.getSelectedButton() !== ui.Button.OK) return;

  const lastNamePrompt = ui.prompt("Last Name", "Enter the last name:", ui.ButtonSet.OK_CANCEL);
  if (lastNamePrompt.getSelectedButton() !== ui.Button.OK) return;

  const lastRow = sheet.getLastRow();
  const newRowIndex = lastRow + 1;
  sheet.insertRowsAfter(lastRow, 1);

  // Copy formatting + validation from Row 2
  sheet.getRange(2, 1, 1, sheet.getLastColumn())
    .copyTo(sheet.getRange(newRowIndex, 1, 1, sheet.getLastColumn()), { formatOnly: true });

  // Set values
  sheet.getRange(newRowIndex, 1).setValue(clientNamePrompt.getResponseText().trim()); // A
  sheet.getRange(newRowIndex, 2).setValue(planPrompt.getResponseText().trim());       // B
  sheet.getRange(newRowIndex, 3).setValue(emailPrompt.getResponseText().trim());      // C
  sheet.getRange(newRowIndex, 4).setValue("Active");                                 // D
  sheet.getRange(newRowIndex, 5).setValue(partnerPrompt.getResponseText().trim());   // E
  sheet.getRange(newRowIndex, 6).setValue(firstNamePrompt.getResponseText().trim()); // F
  sheet.getRange(newRowIndex, 7).setValue(lastNamePrompt.getResponseText().trim());  // G

  ui.alert("‚úÖ New client added to Client Directory.");
}

/**
 * addNewClientToTracker
 * Combined tool:
 * 1) Adds to Client Directory
 * 2) Adds to Master Tracker 2026 (if missing)
 * 3) Sorts Master Tracker A‚ÄìZ by Client Name
 * 4) Ensures client exists in Time Entry
 */
function addNewClientToTracker() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();

  const directorySheet = ss.getSheetByName(DIRECTORY_SHEET_NAME);
  const masterSheet = ss.getSheetByName(MASTER_SHEET_NAME);

  if (!directorySheet) throw new Error(`Sheet "${DIRECTORY_SHEET_NAME}" not found.`);
  if (!masterSheet) throw new Error(`Sheet "${MASTER_SHEET_NAME}" not found.`);

  // Prompts
  const namePrompt = ui.prompt("New Client", "Enter the client domain or name:", ui.ButtonSet.OK_CANCEL);
  if (namePrompt.getSelectedButton() !== ui.Button.OK) return;
  const clientName = namePrompt.getResponseText().trim();

  const planPrompt = ui.prompt("Plan", "Enter plan name/type:", ui.ButtonSet.OK_CANCEL);
  if (planPrompt.getSelectedButton() !== ui.Button.OK) return;
  const planType = planPrompt.getResponseText().trim();

  const emailPrompt = ui.prompt("Email", "Enter client email address:", ui.ButtonSet.OK_CANCEL);
  if (emailPrompt.getSelectedButton() !== ui.Button.OK) return;
  const email = emailPrompt.getResponseText().trim();

  const partnerPrompt = ui.prompt("Partner Agency", "Enter Partner Agency (if applicable):", ui.ButtonSet.OK_CANCEL);
  if (partnerPrompt.getSelectedButton() !== ui.Button.OK) return;
  const partner = partnerPrompt.getResponseText().trim();

  const firstNamePrompt = ui.prompt("First Name", "Enter the first name of the client:", ui.ButtonSet.OK_CANCEL);
  if (firstNamePrompt.getSelectedButton() !== ui.Button.OK) return;
  const firstName = firstNamePrompt.getResponseText().trim();

  const lastNamePrompt = ui.prompt("Last Name", "Enter the last name of the client:", ui.ButtonSet.OK_CANCEL);
  if (lastNamePrompt.getSelectedButton() !== ui.Button.OK) return;
  const lastName = lastNamePrompt.getResponseText().trim();

  // 1) Insert into Client Directory (append)
  const lastDirRow = directorySheet.getLastRow();
  const newDirRow = lastDirRow + 1;
  directorySheet.insertRowsAfter(lastDirRow, 1);

  // Copy formatting from Row 2
  directorySheet.getRange(2, 1, 1, directorySheet.getLastColumn())
    .copyTo(directorySheet.getRange(newDirRow, 1, 1, directorySheet.getLastColumn()), { formatOnly: true });

  // Write values into directory
  directorySheet.getRange(newDirRow, 1).setValue(clientName);  // A
  directorySheet.getRange(newDirRow, 2).setValue(planType);    // B
  directorySheet.getRange(newDirRow, 3).setValue(email);       // C
  directorySheet.getRange(newDirRow, 4).setValue("Active");    // D
  directorySheet.getRange(newDirRow, 5).setValue(partner);     // E
  directorySheet.getRange(newDirRow, 6).setValue(firstName);   // F
  directorySheet.getRange(newDirRow, 7).setValue(lastName);    // G

  // 2) Insert into Master Tracker if missing
  const lastMasterRow = masterSheet.getLastRow();
  const existingNames = (lastMasterRow >= 3)
    ? masterSheet.getRange(3, 2, lastMasterRow - 2, 1).getValues()
        .map(r => (r[0] || "").toString().trim().toLowerCase())
    : [];

  if (!existingNames.includes(clientName.toLowerCase())) {
    const TEMPLATE_ROW = 2;
    const insertAt = masterSheet.getLastRow() + 1;
    masterSheet.insertRowAfter(insertAt - 1);

    // Copy template row to new row
    masterSheet.getRange(TEMPLATE_ROW, 1, 1, masterSheet.getLastColumn())
      .copyTo(masterSheet.getRange(insertAt, 1, 1, masterSheet.getLastColumn()), SpreadsheetApp.CopyPasteType.PASTE_NORMAL, false);

    // Prevent auto-linking on name
    masterSheet.getRange(insertAt, 2).setNumberFormat("@STRING@");

    // Set fields (2026 layout)
    masterSheet.getRange(insertAt, 2).setValue(clientName);  // B Client Name
    masterSheet.getRange(insertAt, 3).setValue("Active");    // C Status
    masterSheet.getRange(insertAt, 11).setValue(email);      // K Email
    masterSheet.getRange(insertAt, 12).setValue(firstName);  // L First Name
    masterSheet.getRange(insertAt, 13).setValue(lastName);   // M Last Name
    masterSheet.getRange(insertAt, 21).setValue(partner);    // U Partner Agency
    masterSheet.getRange(insertAt, 22).setValue(planType);   // V Plan

    // Clear links in P/Q
    masterSheet.getRange(insertAt, 16).clearContent(); // P Folder
    masterSheet.getRange(insertAt, 17).clearContent(); // Q Doc
  }

  // 3) Sort Master Tracker A‚ÄìZ by Client Name (Column B)
  sortMasterTrackerAZ();

  // 4) Ensure in Time Entry
  try {
    ensureClientInTimeEntry_(clientName);
  } catch (e) {
    console.warn("Time Entry add skipped: " + e);
  }

  ui.alert(`‚úÖ Client "${clientName}" added to Directory + Master Tracker + Time Entry.`);
}

/**
 * sortMasterTrackerAZ
 * Sorts the Master Tracker 2026 sheet A‚ÄìZ by Client Name (Column B).
 * Preserves header row 1.
 */
function sortMasterTrackerAZ() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(MASTER_SHEET_NAME);
  if (!sheet) throw new Error(`Sheet "${MASTER_SHEET_NAME}" not found.`);

  const lastRow = sheet.getLastRow();
  if (lastRow <= 2) return; // only header + template

  // Unhide all rows before sorting
  sheet.showRows(2, sheet.getMaxRows() - 1);

  // Sort rows 2..lastRow by Column B
  sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn())
    .sort({ column: 2, ascending: true });

  // Re-hide inactive/transitioning
  hideInactiveAndTransitioningRows();

  console.log("‚úÖ Master Tracker 2026 sorted A‚ÄìZ by Client Name.");
}

/**
 * hideInactiveAndTransitioningRows
 * Master Tracker 2026: Status is Column C (3)
 */
function hideInactiveAndTransitioningRows() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(MASTER_SHEET_NAME);
  if (!sheet) throw new Error(`Sheet "${MASTER_SHEET_NAME}" not found.`);

  const START_ROW = 2;
  const STATUS_COL = 3; // Column C
  const numRows = sheet.getLastRow() - 1;
  if (numRows <= 0) return;

  const statuses = sheet.getRange(START_ROW, STATUS_COL, numRows, 1).getValues();
  sheet.showRows(START_ROW, sheet.getMaxRows() - 1); // unhide all first

  let hiddenCount = 0;
  for (let i = 0; i < statuses.length; i++) {
    const status = (statuses[i][0] || "").toString().trim().toLowerCase();
    if (status === "inactive" || status === "transitioning") {
      sheet.hideRows(START_ROW + i);
      hiddenCount++;
    }
  }

  console.log(`‚úÖ ${hiddenCount} row(s) hidden based on status.`);
}

/**
 * unhideAllClientRows
 */
function unhideAllClientRows() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(MASTER_SHEET_NAME);
  if (!sheet) throw new Error(`Sheet "${MASTER_SHEET_NAME}" not found.`);

  sheet.showRows(2, sheet.getMaxRows() - 1);
  console.log("‚úÖ All client rows unhidden.");
}

/**
 * onEdit
 * Timestamp updates in Client Directory Column K when Columns A‚ÄìK are edited.
 */
function onEdit(e) {
  const sheet = e.source.getActiveSheet();
  if (sheet.getName() !== DIRECTORY_SHEET_NAME) return;

  const editedRow = e.range.getRow();
  const editedCol = e.range.getColumn();

  // Only run if Columns A‚ÄìK (1‚Äì11) edited, and not header
  if (editedRow > 1 && editedCol >= 1 && editedCol <= 11) {
    sheet.getRange(editedRow, 11).setValue(new Date()); // Column K
  }
}

/**
 * onOpen
 * Adds the Client Tools menu when the spreadsheet is opened.
 */
function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu("‚ù§Ô∏è Client Tools")
    .addItem("üìÑ Run Monthly Rollover + Create Docs (Safe Mode)", "monthlyRolloverAndCreateDocsSafe")
    .addSeparator()
    .addItem("‚ûï Add Client and Sync to Master Tracker 2026", "addNewClientToTracker")
    .addSeparator()
    .addItem("üìã Insert All Missing Clients to Master Tracker 2026", "insertAllMissingClients")
    .addItem("üî§ Sort Master Tracker 2026 A‚ÄìZ", "sortMasterTrackerAZ")
    .addItem("üóÇ Insert New Client into Directory", "insertNewClientIntoDirectory")
    .addSeparator()
    .addItem("üôà Hide Inactive/Transitioning Rows", "hideInactiveAndTransitioningRows")
    .addItem("ü´£ Unhide All Client Rows", "unhideAllClientRows")
    .addSeparator()
    .addItem("üßæ Sync ALL Master Tracker clients into Time Entry", "syncAllClientsToTimeEntry")
    .addToUi();
}

/**
 * ensureClientInTimeEntry_
 * Ensures a single row exists for the client in Time Entry.
 * - Copies template row (TIME_ENTRY_TEMPLATE_ROW)
 * - Sets client name in Column A as text
 * - Idempotent
 */
function ensureClientInTimeEntry_(clientName) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const te = ss.getSheetByName(TIME_ENTRY_SHEET);
  if (!te) throw new Error(`Sheet "${TIME_ENTRY_SHEET}" not found.`);

  const lastRow = te.getLastRow(); // may be 1 if only headers

  // Read existing names from row 2 down (if any)
  let names = [];
  if (lastRow >= 2) {
    names = te.getRange(2, 1, lastRow - 1, 1)
      .getValues()
      .map(r => (r[0] || "").toString().trim().toLowerCase());
  }

  const target = (clientName || "").toString().trim().toLowerCase();
  if (!target) return false;
  if (names.indexOf(target) !== -1) return false;

  // Insert new row at bottom
  const insertAt = lastRow + 1;     // if only header, becomes 2
  te.insertRowAfter(insertAt - 1);  // insert after last existing row

  // Copy template row into new row
  te.getRange(TIME_ENTRY_TEMPLATE_ROW, 1, 1, te.getLastColumn())
    .copyTo(te.getRange(insertAt, 1, 1, te.getLastColumn()), { contentsOnly: false });

  // Set client name as text (avoid auto-linking)
  te.getRange(insertAt, 1).setNumberFormat("@STRING@");
  te.getRange(insertAt, 1).setValue(clientName);

  console.log(`‚úÖ Added "${clientName}" to Time Entry at row ${insertAt}`);
  return true;
}

/**
 * syncAllClientsToTimeEntry
 * Syncs all client names from Master Tracker 2026 Column B into Time Entry.
 */
function syncAllClientsToTimeEntry() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const tracker = ss.getSheetByName(MASTER_SHEET_NAME);
  if (!tracker) throw new Error(`Sheet "${MASTER_SHEET_NAME}" not found.`);

  const lastRow = tracker.getLastRow();
  if (lastRow < 3) {
    SpreadsheetApp.getUi().alert("No client rows found to sync.");
    return;
  }

  const names = tracker.getRange(3, 2, lastRow - 2, 1).getValues();

  let added = 0;
  names.forEach(r => {
    const clientName = r[0];
    if (clientName && ensureClientInTimeEntry_(clientName)) {
      added++;
    }
  });

  SpreadsheetApp.getUi().alert(`‚úÖ Sync complete. ${added} client(s) added to Time Entry.`);
}
